<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>CodeSec - Secure Messenger</title>
<style>
* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html, body { overflow-y: auto; overflow-x: hidden; }
::-webkit-scrollbar { width:0; height:0; }
body {
  margin:0;
  min-height:100vh;
  background:#0b0e17;
  font-family:Tahoma,sans-serif;
  color:#fff;
}
.container { max-width:720px; margin:auto; padding:20px; }
.card {
  background:rgba(255,255,255,0.1);
  backdrop-filter:blur(18px);
  border-radius:20px;
  padding:20px;
}
h2 { text-align:center; margin-bottom:20px; }
.field {
  margin-bottom:18px;
}
textarea, input {
  width:100%;
  border:none;
  border-radius:14px;
  padding:14px;
  background:rgba(0,0,0,.35);
  color:#fff;
  font-size:14px;
}
textarea {
  min-height:140px;
  resize:none;
  font-family:Consolas,monospace;
}
/* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Liquid Metal */
.liquid-btn, .action-btn {
  background:linear-gradient(145deg, #2a2f3f, #1a1d28);
  border:none;
  border-radius:50%;
  box-shadow:0 6px 20px rgba(0,0,0,0.6), inset 0 3px 12px rgba(255,255,255,0.15), inset 0 -3px 12px rgba(0,0,0,0.4);
  cursor:pointer;
  color:#fff;
  transition: all 0.3s ease;
  display:flex;
  align-items:center;
  justify-content:center;
  animation: pulse 4s infinite ease-in-out;
}
.liquid-btn:hover, .action-btn:hover {
  transform:scale(1.15);
  background:linear-gradient(145deg, #3a4055, #252a38);
  box-shadow:0 10px 30px rgba(76,194,255,0.5), inset 0 4px 15px rgba(76,194,255,0.3);
}
@keyframes pulse {
  0%, 100% { box-shadow: 0 6px 20px rgba(0,0,0,0.6), inset 0 3px 12px rgba(255,255,255,0.15); }
  50% { box-shadow: 0 8px 25px rgba(76,194,255,0.2), inset 0 4px 15px rgba(255,255,255,0.2); }
}
.action-group { display: flex; flex-direction: column; align-items: center; margin: 16px 0; }
.action-btn { width:80px; height:80px; font-size:20px; font-weight:bold; }
.eye-group { display: flex; justify-content: flex-end; margin-bottom: 8px; }
.liquid-btn { width:50px; height:50px; font-size:24px; }
/* Ø±Ø§Ø¯ÛŒÙˆ Ø¨Ø§ØªÙ†â€ŒÙ‡Ø§ */
.mode-selector { display: flex; justify-content: center; gap: 50px; margin: 20px 0; font-size: 15px; }
.mode-option { display: flex; align-items: center; gap: 10px; cursor: pointer; }
.mode-option input[type="radio"] {
  appearance: none;
  width: 24px;
  height: 24px;
  border: 3px solid #555;
  border-radius: 50%;
  background: transparent;
  position: relative;
  transition: all 0.3s;
}
.mode-option input[type="radio"]:checked { border-color: #4cc2ff; }
.mode-option input[type="radio"]::before {
  content: "";
  position: absolute;
  width: 12px;
  height: 12px;
  background: #4cc2ff;
  border-radius: 50%;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0);
  transition: transform 0.3s;
}
.mode-option input[type="radio"]:checked::before { transform: translate(-50%, -50%) scale(1); }
.buttons { display:flex; gap:14px; margin:24px 0; }
button {
  flex:1;
  padding:14px;
  border:none;
  border-radius:16px;
  font-size:15px;
  font-weight:bold;
  color:#fff;
  background:#4cc2ff;
}
#decryptBtn { background:#ff4c4c; }
.help { margin-top: 30px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 16px; font-size: 13px; line-height: 1.6; opacity: 0.9; }
.help h3 { text-align: center; margin: 12px 0 8px; }
footer { margin-top:16px; text-align:center; font-size:12px; opacity:.6; }
.note.warning {
  color:#ff4444;
  border:1px solid #ff4444;
  background:rgba(255,68,68,0.1);
  padding:12px;
  border-radius:12px;
  margin-top:10px;
  font-size:13px;
}
/* Ù…Ù†ÙˆÛŒ Ù‡Ù…Ø¨Ø±Ú¯Ø±ÛŒ */
.hamburger {
  position:fixed;
  top:20px;
  right:20px;
  z-index:1000;
  width:50px;
  height:50px;
  background:linear-gradient(145deg, #2a2f3f, #1a1d28);
  border-radius:50%;
  box-shadow:0 6px 20px rgba(0,0,0,0.6);
  cursor:pointer;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:5px;
}
.hamburger span {
  width:24px;
  height:3px;
  background:#fff;
  border-radius:3px;
  transition:all 0.3s;
}
.hamburger.active span:nth-child(1) { transform:rotate(45deg) translate(6px,6px); }
.hamburger.active span:nth-child(2) { opacity:0; }
.hamburger.active span:nth-child(3) { transform:rotate(-45deg) translate(6px,-6px); }
.sidebar {
  position:fixed;
  top:0;
  right:-300px;
  width:280px;
  height:100%;
  background:rgba(10,13,23,0.95);
  backdrop-filter:blur(20px);
  z-index:999;
  transition:right 0.4s ease;
  padding:80px 20px 20px;
}
.sidebar.active { right:0; }
.sidebar-item {
  padding:16px;
  margin:8px 0;
  background:rgba(255,255,255,0.05);
  border-radius:16px;
  cursor:pointer;
  font-size:16px;
}
.sidebar-item:hover { background:rgba(76,194,255,0.2); }
.page { display:none; }
.page.active { display:block; }
/* ØµÙØ­Ù‡ Ú†Øª Ø¬Ø¯ÛŒØ¯ */
#roomTitle {
  color:#4cc2ff;
  font-weight:bold;
  text-align:right;
  margin-bottom:10px;
  font-size:18px;
}
.chat-messages {
  height:55vh;
  overflow-y:auto;
  margin:20px 0;
  padding:10px;
}
.message {
  max-width:75%;
  margin:8px 0;
  padding:12px;
  border-radius:18px;
  background:rgba(255,255,255,0.1);
  position:relative;
  cursor:pointer;
  transition: background 0.3s;
}
.message.sent { 
  margin-left:auto; 
  background:#4cc2ff; 
}
.message.received { 
  margin-right:auto; 
  background:rgba(255,255,255,0.15); 
}
.message-user { 
  font-size:12px; 
  opacity:0.8; 
  margin-bottom:4px; 
}
.message-time {
  font-size:11px;
  opacity:0.7;
  margin-top:6px;
  text-align:left;
}
.message-tick {
  font-size:12px;
  margin-right:6px;
}
.tick-sent { color:#ccc; }
.tick-read { color:#fff; font-weight:bold; }
/* Ø±ÛŒÙ¾Ù„Ø§ÛŒ */
.reply-box {
  border-right:4px solid #4cc2ff;
  padding-right:10px;
  margin-bottom:8px;
  opacity:0.8;
  font-size:13px;
  cursor:pointer;
}
.reply-user { font-weight:bold; font-size:12px; }
.reply-text { opacity:0.8; }
/* Ù†ÙˆØ§Ø± ÙˆØ±ÙˆØ¯ÛŒ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù…Ø«Ù„ Ø¹Ú©Ø³ Ù†Ù‡Ø§ÛŒÛŒ */
.message-input-group {
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:#0b0e17;
  padding:12px 20px;
  display:flex;
  align-items:center;
  gap:12px;
}
#messageInput {
  flex:1;
  background:rgba(255,255,255,0.08);
  border:none;
  outline:none;
  color:#fff;
  font-size:15px;
  padding:14px 20px;
  border-radius:40px;
}
#sendBtn {
  width:50px;
  height:50px;
  border-radius:50%;
  background:#4cc2ff;
  border:none;
  color:#fff;
  font-size:22px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 4px 15px rgba(76,194,255,0.6);
  flex-shrink:0;
}
/* ÙØ¶Ø§ÛŒ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ§Ø± Ù¾Ø§ÛŒÛŒÙ† */
#chat-page .card {
  padding-bottom:90px;
}
/* ØµÙØ­Ù‡ Ø§Ù†ØªØ¸Ø§Ø± */
.waiting-page { text-align:center; padding:60px 20px; }
.loader {
  width:100px;
  height:100px;
  border:10px solid rgba(76,194,255,0.2);
  border-top:10px solid #4cc2ff;
  border-radius:50%;
  animation: spin 1.2s linear infinite;
  margin:40px auto;
}
@keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
/* ØµÙØ­Ù‡ Ø§ÙØ±Ø§Ø¯ Ø±ÙˆÙ… */
#room-members-page .user-item {
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:rgba(255,255,255,0.05);
  padding:12px;
  border-radius:12px;
  margin-bottom:10px;
}
.user-item span { flex:1; }
.user-item .user-actions { display:flex; gap:8px; }
.user-item .user-actions button { padding:6px 10px; font-size:12px; background:#4cc2ff; border-radius:8px; }
.user-item .user-actions button.ban { background:#ff4444; }
.user-item .user-actions button.admin { background:#50fa7b; }
/* Ø¯Ú©Ù…Ù‡ Ø±ÙØ±Ø´ */
#refreshMembersBtn {
  width:100%;
  padding:12px;
  background:#4cc2ff;
  border:none;
  border-radius:12px;
  font-size:15px;
  margin-bottom:15px;
  cursor:pointer;
}
</style>
</head>
<body>

<!-- Ù…Ù†ÙˆÛŒ Ù‡Ù…Ø¨Ø±Ú¯Ø±ÛŒ -->
<div class="hamburger" id="hamburger">
  <span></span>
  <span></span>
  <span></span>
</div>

<!-- Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item" data-page="home">ğŸ  Ø®Ø§Ù†Ù‡ (Ø§Ø¨Ø²Ø§Ø± Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ)</div>
  <div class="sidebar-item" data-page="create-room">â• Ø³Ø§Ø®Øª Ø±ÙˆÙ… Ø¬Ø¯ÛŒØ¯</div>
  <div class="sidebar-item" data-page="join-room">ğŸ”‘ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø±ÙˆÙ…</div>
  <div class="sidebar-item" data-page="manage-rooms">ğŸ“‚ Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÙ…â€ŒÙ‡Ø§</div>
  <div class="sidebar-item" data-page="room-settings-page" id="roomSettingsMenu" style="display:none;">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±ÙˆÙ…</div>
  <div class="sidebar-item" data-page="room-members-page" id="roomMembersMenu" style="display:none;">ğŸ‘¥ Ø§ÙØ±Ø§Ø¯ Ø±ÙˆÙ…</div>
  <div class="sidebar-item" data-page="chat-page" id="returnToRoomMenu" style="display:none;">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø±ÙˆÙ…</div>
  <div class="sidebar-item" data-page="username-page" id="usernameMenuItem">ğŸ‘¤ ØªÙ†Ø¸ÛŒÙ… Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</div>
</div>

<div class="container">

  <!-- ØµÙØ­Ù‡ Ø®Ø§Ù†Ù‡ -->
  <div class="card page active" id="home">
    <h2>Secure Vault</h2>
    <div class="action-group">
      <button class="action-btn" id="pasteBtn">Paste<br>ğŸ“„</button>
    </div>
    <div class="eye-group">
      <button class="liquid-btn" id="togglePlain">ğŸ‘</button>
    </div>
    <div class="field">
      <textarea id="plainText" placeholder="Ù…ØªÙ† Ù…Ø­Ø±Ù…Ø§Ù†Ù‡ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ ÛŒØ§ Ù¾ÛŒØ³Øª Ú©Ù†ÛŒØ¯"></textarea>
    </div>
    <div class="mode-selector">
      <label class="mode-option">
        <input type="radio" name="appMode" value="file" checked>
        <span>File</span>
      </label>
      <label class="mode-option">
        <input type="radio" name="appMode" value="copy">
        <span>Copy/Paste</span>
      </label>
    </div>
    <div class="eye-group">
      <button class="liquid-btn" id="togglePass">ğŸ‘</button>
    </div>
    <div class="field">
      <input id="password" type="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
    </div>
    <div class="buttons">
      <button id="encryptBtn">Encrypt</button>
      <button id="decryptBtn">Decrypt</button>
    </div>
    <div class="field">
      <textarea id="output" placeholder="Ø®Ø±ÙˆØ¬ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯" readonly></textarea>
    </div>
    <div class="action-group">
      <button class="action-btn" id="copyBtn">Copy<br>ğŸ“‹</button>
    </div>
    <input id="fileInput" type="file" accept=".txt,.enc" hidden>
    <div class="help">
      <h3>ğŸ“– Ø±Ø§Ù‡Ù†Ù…Ø§</h3>
      <p><strong>File Mode:</strong> ÙØ§ÛŒÙ„ Ø¯Ø§Ù†Ù„ÙˆØ¯/Ø¢Ù¾Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯</p>
      <p><strong>Copy/Paste Mode:</strong> ØªÙˆØµÛŒÙ‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ú¯ÙˆØ´ÛŒ</p>
      <p>Ø§Ú¯Ø± Ø¯Ú©Ù…Ù‡ Paste Ú©Ø§Ø± Ù†Ú©Ø±Ø¯: Ø¯Ø§Ø®Ù„ Ø¨Ø§Ú©Ø³ Long Press â†’ Paste</p>
    </div>
    <footer>AES-256-GCM â€¢ PBKDF2 â€¢ 100% Client-Side</footer>
  </div>

  <!-- ØµÙØ­Ù‡ ØªÙ†Ø¸ÛŒÙ… Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ -->
  <div class="card page" id="username-page">
    <h2>ØªÙ†Ø¸ÛŒÙ… Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</h2>
    <div class="field">
      <input type="text" id="usernameInput" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ù„Ø®ÙˆØ§Ù‡ (Ø­Ø¯Ø§Ù‚Ù„ 3 Ú©Ø§Ø±Ø§Ú©ØªØ±)">
      <div id="usernameStatus"></div>
    </div>
    <div class="note warning">
      Ù†Ú©ØªÙ‡: Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙÙ‚Ø· Ø¯Ùˆ Ø¨Ø§Ø± Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ± Ø§Ø³Øª. Ø¨Ø§ Ø¯Ù‚Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯!
    </div>
    <div class="buttons">
      <button id="saveUsernameBtn">Ø°Ø®ÛŒØ±Ù‡ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</button>
    </div>
  </div>

  <!-- ØµÙØ­Ù‡ Ø³Ø§Ø®Øª Ø±ÙˆÙ… -->
  <div class="card page" id="create-room">
    <h2>Ø³Ø§Ø®Øª Ø±ÙˆÙ… Ø¬Ø¯ÛŒØ¯</h2>
    <div class="field">
      <input type="text" id="newRoomId" placeholder="Ø¢ÛŒØ¯ÛŒ Ø¯Ù„Ø®ÙˆØ§Ù‡ Ø±ÙˆÙ… (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)">
      <div id="roomIdStatus"></div>
    </div>
    <div class="note warning">
      Ù†Ú©ØªÙ‡: Ø­Ø¯Ø§Ù‚Ù„ ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¬Ø§Ø² Ú©Ø§Ø±Ø§Ú©ØªØ± 3 Ø§Ø³Øª Ùˆ Ø¨Ø§ÛŒØ¯ Ú©Ø§Ø±Ø§Ú©ØªØ± Ù‡Ø§ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ø§Ø´Ù†Ø¯ (a-z, 0-9, -, _)
    </div>
    <div class="buttons">
      <button id="createRoomBtn">Create & Join</button>
    </div>
  </div>

  <!-- ØµÙØ­Ù‡ Ø¬ÙˆÛŒÙ† Ø±ÙˆÙ… -->
  <div class="card page" id="join-room">
    <h2>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø±ÙˆÙ…</h2>
    <div class="field">
      <input type="text" id="joinRoomId" placeholder="Ø¢ÛŒØ¯ÛŒ Ø±ÙˆÙ… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
      <div id="joinStatus"></div>
    </div>
    <div class="buttons">
      <button id="joinRoomBtn">Join</button>
    </div>
  </div>

  <!-- ØµÙØ­Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±ÙˆÙ… -->
  <div class="card page" id="room-settings-page">
    <h2>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±ÙˆÙ…</h2>
    <p>Ø±ÙˆÙ… ÙØ¹Ù„ÛŒ: <strong id="currentRoomName"></strong></p>
    <p>Ø­Ø§Ù„Øª ÙˆØ±ÙˆØ¯:</p>
    <div class="mode-selector">
      <label class="mode-option">
        <input type="radio" name="roomMode" value="open" checked>
        <span>Ø¢Ø²Ø§Ø¯ (Ù‡Ø±Ú©ÛŒ Ø¢ÛŒØ¯ÛŒ Ø¨Ø¯ÙˆÙ†Ù‡ ÙˆØ§Ø±Ø¯ Ù…ÛŒâ€ŒØ´Ù‡)</span>
      </label>
      <label class="mode-option">
        <input type="radio" name="roomMode" value="permission">
        <span>Ø¨Ø§ Ø§Ø¬Ø§Ø²Ù‡ (ÙÙ‚Ø· Ø¨Ø§ ØªØ£ÛŒÛŒØ¯ Ù‡Ø§Ø³Øª)</span>
      </label>
    </div>
    <div class="buttons">
      <button id="saveRoomModeBtn">Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
    </div>
    <div id="roomModeStatus"></div>
    <h3 style="margin-top:30px;">Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯</h3>
    <div id="requestsList">
      <p style="text-align:center;opacity:0.7;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
    </div>
  </div>

  <!-- ØµÙØ­Ù‡ Ú†Øª -->
  <div class="card page" id="chat-page">
    <div id="roomTitle">Ø±ÙˆÙ…: ...</div>
    <div class="chat-messages" id="messages"></div>
    <div class="message-input-group">
      <input type="text" id="messageInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">
      <button id="sendBtn">â¤</button>
    </div>
  </div>

  <!-- ØµÙØ­Ù‡ Ø§Ù†ØªØ¸Ø§Ø± -->
  <div class="card page" id="waiting-page">
    <div class="waiting-page">
      <div class="loader"></div>
      <h3>Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯ Ù‡Ø§Ø³Øª...</h3>
      <p>Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆØ±ÙˆØ¯ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯</p>
      <p>Ù„Ø·ÙØ§Ù‹ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÛŒØ¯ ØªØ§ Ù‡Ø§Ø³Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†Ø¯</p>
    </div>
  </div>

  <!-- ØµÙØ­Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÙ…â€ŒÙ‡Ø§ -->
  <div class="card page" id="manage-rooms">
    <h2>Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÙ…â€ŒÙ‡Ø§</h2>
    <p>Ø±ÙˆÙ…â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø´Ù…Ø§ Ø³Ø§Ø®ØªÙ‡â€ŒØ§ÛŒØ¯:</p>
    <div id="myRoomsList" class="room-list">
      <p style="text-align:center;opacity:0.7;">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
    </div>
  </div>

  <!-- ØµÙØ­Ù‡ Ø§ÙØ±Ø§Ø¯ Ø±ÙˆÙ… -->
  <div class="card page" id="room-members-page">
    <h2>Ø§ÙØ±Ø§Ø¯ Ø±ÙˆÙ…</h2>
    <button id="refreshMembersBtn">Ø±ÙØ±Ø´ ÙˆØ¶Ø¹ÛŒØª</button>
    <div id="roomMembersList">
      <p style="text-align:center;opacity:0.7;">Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ù„ÛŒØ³ØªØŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø±ÙØ±Ø´ Ø¨Ø²Ù†ÛŒØ¯</p>
    </div>
  </div>

</div>

<script>
// Ù„ÛŒÙ†Ú© Worker
const WORKER_URL = "https://frosty-rain-369.alijayz.workers.dev/api";

// Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
let currentRoom = null;
let username = localStorage.getItem('username') || null;
let usernameChanges = parseInt(localStorage.getItem('usernameChanges') || '0');
let isOwner = false;
let pendingRoomId = null;
let replyTo = null;
let refreshCooldown = false;

// Ù…Ù†ÙˆÛŒ Ù‡Ù…Ø¨Ø±Ú¯Ø±ÛŒ
const hamburger = document.getElementById('hamburger');
const sidebar = document.getElementById('sidebar');
hamburger.addEventListener('click', () => {
  hamburger.classList.toggle('active');
  sidebar.classList.toggle('active');
  document.getElementById('returnToRoomMenu').style.display = currentRoom ? 'block' : 'none';
});

// Ø³ÙˆØ¦ÛŒÚ† ØµÙØ­Ù‡
document.querySelectorAll('.sidebar-item[data-page]').forEach(item => {
  item.addEventListener('click', () => {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(item.dataset.page).classList.add('active');
    hamburger.classList.remove('active');
    sidebar.classList.remove('active');
    if (item.dataset.page === "manage-rooms") loadMyRooms();
    if (item.dataset.page === "room-settings-page") loadRequests();
  });
});

// Ø¯Ú©Ù…Ù‡ Ø±ÙØ±Ø´ Ø¨Ø§ Ú©ÙˆÙ„Ø¯Ø§ÙˆÙ† Û±Û° Ø«Ø§Ù†ÛŒÙ‡
document.getElementById('refreshMembersBtn').addEventListener('click', () => {
  if (refreshCooldown) return;
  refreshCooldown = true;
  document.getElementById('refreshMembersBtn').textContent = 'Û±Û° Ø«Ø§Ù†ÛŒÙ‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...';
  document.getElementById('refreshMembersBtn').disabled = true;
  loadRoomMembers();
  setTimeout(() => {
    refreshCooldown = false;
    document.getElementById('refreshMembersBtn').textContent = 'Ø±ÙØ±Ø´ ÙˆØ¶Ø¹ÛŒØª';
    document.getElementById('refreshMembersBtn').disabled = false;
  }, 10000);
});

// Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Enter (Shift + Enter Ø¨Ø±Ø§ÛŒ Ø®Ø· Ø¬Ø¯ÛŒØ¯)
document.getElementById('messageInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    document.getElementById('sendBtn').click();
  }
});

// ØªÙ†Ø¸ÛŒÙ… Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ
document.getElementById('saveUsernameBtn').addEventListener('click', () => {
  if (usernameChanges >= 2) {
    document.getElementById('usernameStatus').innerHTML = '<p style="color:#ff6b6b;">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯ÛŒÚ¯Ø± Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ± Ù†ÛŒØ³Øª!</p>';
    return;
  }
  const name = document.getElementById('usernameInput').value.trim();
  if (!name || name.length < 3) {
    document.getElementById('usernameStatus').innerHTML = '<p style="color:#ff6b6b;">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø­Ø¯Ø§Ù‚Ù„ 3 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯</p>';
    return;
  }
  username = name;
  localStorage.setItem('username', username);
  usernameChanges++;
  localStorage.setItem('usernameChanges', usernameChanges.toString());
  document.getElementById('usernameStatus').innerHTML = '<p style="color:#50fa7b;">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯: ' + name + '</p>';
  if (usernameChanges >= 2) document.getElementById('usernameMenuItem').style.display = 'none';
});

// Ú†Ú© Ø¢ÛŒØ¯ÛŒ Ø±ÙˆÙ…
document.getElementById('newRoomId').addEventListener('input', async () => {
  const id = document.getElementById('newRoomId').value.trim().toLowerCase();
  const status = document.getElementById('roomIdStatus');
  if (id.length < 3) {
    status.innerHTML = '<p style="color:#ff6b6b;">Ø­Ø¯Ø§Ù‚Ù„ 3 Ú©Ø§Ø±Ø§Ú©ØªØ±</p>';
    return;
  }
  if (!/^[a-z0-9_-]+$/.test(id)) {
    status.innerHTML = '<p style="color:#ff6b6b;">ÙÙ‚Ø· Ø­Ø±ÙˆÙ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ Ø¹Ø¯Ø¯ØŒ - Ùˆ _</p>';
    return;
  }
  try {
    const res = await fetch(`${WORKER_URL}/room-data?roomId=${id}`);
    if (res.ok) {
      status.innerHTML = '<p style="color:#ff6b6b;">Ø§ÛŒÙ† Ø¢ÛŒØ¯ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ø§Ø³Øª</p>';
    } else {
      status.innerHTML = '<p style="color:#50fa7b;">Ø¢ÛŒØ¯ÛŒ Ø¢Ø²Ø§Ø¯ Ø§Ø³Øª</p>';
    }
  } catch {
    status.innerHTML = '<p style="color:#ff6b6b;">Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„</p>';
  }
});

// Ø³Ø§Ø®Øª Ø±ÙˆÙ…
document.getElementById('createRoomBtn').addEventListener('click', async () => {
  if (!username) return alert("Ø§Ø¨ØªØ¯Ø§ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯");
  const id = document.getElementById('newRoomId').value.trim().toLowerCase();
  if (!id || id.length < 3 || !/^[a-z0-9_-]+$/.test(id)) return alert("Ø¢ÛŒØ¯ÛŒ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
  try {
    const res = await fetch(`${WORKER_URL}/create-room`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({roomId: id, username})
    });
    const data = await res.json();
    if (data.success) {
      enterRoom(id);
    } else {
      alert(data.error || "Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª Ø±ÙˆÙ…");
    }
  } catch {
    alert("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±");
  }
});

// Ø¬ÙˆÛŒÙ† Ø±ÙˆÙ…
document.getElementById('joinRoomBtn').addEventListener('click', async () => {
  if (!username) return alert("Ø§Ø¨ØªØ¯Ø§ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯");
  const id = document.getElementById('joinRoomId').value.trim().toLowerCase();
  if (!id) return alert("Ø¢ÛŒØ¯ÛŒ Ø±ÙˆÙ… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
  try {
    const res = await fetch(`${WORKER_URL}/join-room`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({roomId: id, username})
    });
    const data = await res.json();
    if (data.success) {
      enterRoom(id);
    } else if (data.status === "pending") {
      pendingRoomId = id;
      showWaitingPage();
    } else {
      document.getElementById('joinStatus').innerHTML = '<p style="color:#ff6b6b;">' + (data.error || "Ø±ÙˆÙ… ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯") + '</p>';
    }
  } catch {
    alert("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±");
  }
});

// Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ø§Ù†ØªØ¸Ø§Ø±
function showWaitingPage() {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('waiting-page').classList.add('active');
  checkPendingStatus();
  setInterval(checkPendingStatus, 3000);
}

// Ú†Ú© ÙˆØ¶Ø¹ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øª
async function checkPendingStatus() {
  if (!pendingRoomId) return;
  try {
    const res = await fetch(`${WORKER_URL}/room-data?roomId=${pendingRoomId}&username=${username}`);
    if (!res.ok) return;
    const data = await res.json();
    if (data.isMember) {
      pendingRoomId = null;
      enterRoom(pendingRoomId);
    } else if (!data.hasRequest) {
      pendingRoomId = null;
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('join-room').classList.add('active');
      document.getElementById('joinStatus').innerHTML = '<p style="color:#ff6b6b;">Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ ØªÙˆØ³Ø· Ù‡Ø§Ø³Øª Ø±Ø¯ Ø´Ø¯</p>';
    }
  } catch {
    console.log("Ø®Ø·Ø§ Ø¯Ø± Ú†Ú© ÙˆØ¶Ø¹ÛŒØª");
  }
}

// ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø±ÙˆÙ…
async function enterRoom(id) {
  currentRoom = id;
  pendingRoomId = null;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('chat-page').classList.add('active');
  document.getElementById('roomTitle').textContent = `Ø±ÙˆÙ…: ${id}`;
  document.getElementById('roomMembersMenu').style.display = 'block';
  document.getElementById('returnToRoomMenu').style.display = 'block';
  loadRoomData();
  setInterval(loadRoomData, 3000);
}

// Ù„ÙˆØ¯ Ø±ÙˆÙ…
async function loadRoomData() {
  if (!currentRoom) return;
  try {
    const res = await fetch(`${WORKER_URL}/room-data?roomId=${currentRoom}&username=${username}`);
    if (!res.ok) return;
    const data = await res.json();
    if (!data.isMember) {
      currentRoom = null;
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('join-room').classList.add('active');
      document.getElementById('joinStatus').innerHTML = '<p style="color:#ff6b6b;">Ø¯Ø³ØªØ±Ø³ÛŒ Ø´Ù…Ø§ Ø¨Ù‡ Ø§ÛŒÙ† Ø±ÙˆÙ… Ù‚Ø·Ø¹ Ø´Ø¯Ù‡ Ø§Ø³Øª</p>';
      return;
    }
    isOwner = data.isOwner;
    document.getElementById('roomSettingsMenu').style.display = isOwner ? 'block' : 'none';

    const container = document.getElementById('messages');
    container.innerHTML = '';
    (data.messages || []).forEach((msg, index) => {
      const div = document.createElement('div');
      div.className = 'message ' + (msg.user === username ? 'sent' : 'received');
      div.dataset.msgIndex = index;

      let replyHtml = '';
      if (msg.replyTo !== undefined && data.messages[msg.replyTo]) {
        const orig = data.messages[msg.replyTo];
        replyHtml = `
          <div class="reply-box" onclick="scrollToMessage(${msg.replyTo})">
            <div class="reply-user">${orig.user}</div>
            <div class="reply-text">${orig.text.substring(0,50)}${orig.text.length > 50 ? '...' : ''}</div>
          </div>
        `;
      }

      const time = new Date(msg.time || Date.now()).toLocaleTimeString('fa-IR', {hour: '2-digit', minute:'2-digit'});
      const otherMembers = data.members.filter(m => m.name !== username);
      const tick = msg.user === username ? (otherMembers.length > 0 ? '<span class="message-tick tick-read">âœ“âœ“</span>' : '<span class="message-tick tick-sent">âœ“</span>') : '';

      div.innerHTML = replyHtml + `
        <div class="message-user">${msg.user}</div>
        ${msg.text}
        <div class="message-time">${time} ${tick}</div>
      `;

      div.addEventListener('click', () => {
        const readers = data.members.filter(m => m.name !== msg.user).map(m => m.name);
        alert(`Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯Ù‡ ØªÙˆØ³Ø·: ${readers.length > 0 ? readers.join(', ') : 'Ù‡Ù†ÙˆØ² Ú©Ø³ÛŒ Ù†Ø®ÙˆØ§Ù†Ø¯Ù‡'}`);
      });

      let touchStartX = 0;
      div.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
      });
      div.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].clientX;
        const diff = touchStartX - touchEndX;
        if (diff > 50) {
          replyTo = index;
          document.getElementById('messageInput').placeholder = 'Ø¯Ø± Ù¾Ø§Ø³Ø® Ø¨Ù‡ ' + msg.user + '...';
          document.getElementById('messageInput').focus();
        }
      });

      container.appendChild(div);
    });
    container.scrollTop = container.scrollHeight;
  } catch (e) {
    console.log("Ø®Ø·Ø§ Ø¯Ø± Ù„ÙˆØ¯ Ø±ÙˆÙ…");
  }
}

function scrollToMessage(index) {
  const msg = document.querySelector(`.message[data-msg-index="${index}"]`);
  if (msg) {
    msg.scrollIntoView({behavior: 'smooth', block: 'center'});
    msg.style.background = msg.classList.contains('sent') ? '#5dd3ff' : 'rgba(76,194,255,0.4)';
    setTimeout(() => {
      msg.style.background = msg.classList.contains('sent') ? '#4cc2ff' : 'rgba(255,255,255,0.15)';
    }, 1000);
  }
}

// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
document.getElementById('sendBtn').addEventListener('click', async () => {
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  if (!text) {
    if (replyTo !== null) {
      replyTo = null;
      input.placeholder = "Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...";
    }
    return;
  }
  try {
    await fetch(`${WORKER_URL}/send-message`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        roomId: currentRoom,
        username,
        text,
        replyTo: replyTo || undefined
      })
    });
    input.value = '';
    replyTo = null;
    input.placeholder = "Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...";
    loadRoomData();
  } catch {
    alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„");
  }
});

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙØ±Ø§Ø¯ Ø±ÙˆÙ…
async function loadRoomMembers() {
  if (!currentRoom) {
    document.getElementById('roomMembersList').innerHTML = '<p style="color:#ff6b6b;">Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ ÛŒÚ© Ø±ÙˆÙ… Ø´ÙˆÛŒØ¯</p>';
    return;
  }
  try {
    const res = await fetch(`${WORKER_URL}/room-data?roomId=${currentRoom}&username=${username}`);
    if (!res.ok) {
      document.getElementById('roomMembersList').innerHTML = '<p style="color:#ff6b6b;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</p>';
      return;
    }
    const data = await res.json();
    const admins = data.admins || [];
    const isAdmin = data.isOwner || admins.includes(username);
    let html = '';
    data.members.forEach(member => {
      html += `
        <div class="user-item">
          <span>${member.name}</span>
          ${isAdmin && member.name !== username ? `
            <div class="user-actions">
              <button onclick="kickUser('${member.name}')">Ø­Ø°Ù</button>
              <button class="ban" onclick="banUser('${member.name}')">Ø¨Ù†</button>
              <button class="admin" onclick="toggleAdmin('${member.name}')">${admins.includes(member.name) ? 'Ø­Ø°Ù Ù…Ø¯ÛŒØ±' : 'Ø§Ø±ØªÙ‚Ø§ Ø¨Ù‡ Ù…Ø¯ÛŒØ±'}</button>
            </div>
          ` : ''}
        </div>
      `;
    });
    document.getElementById('roomMembersList').innerHTML = html || '<p style="opacity:0.7;">Ù‡ÛŒÚ† Ø¹Ø¶ÙˆÛŒ Ù†ÛŒØ³Øª</p>';
  } catch {
    document.getElementById('roomMembersList').innerHTML = '<p style="color:#ff6b6b;">Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„</p>';
  }
}

// Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
async function kickUser(user) {
  if (confirm(`Ø¢ÛŒØ§ ${user} Ø±Ø§ Ø§Ø² Ø±ÙˆÙ… Ø­Ø°Ù Ú©Ù†ÛŒÙ…ØŸ`)) {
    await manageUser('kick', user);
  }
}
async function banUser(user) {
  if (confirm(`Ø¢ÛŒØ§ ${user} Ø±Ø§ Ø¨Ù† Ú©Ù†ÛŒÙ…ØŸ`)) {
    await manageUser('ban', user);
  }
}
async function manageUser(action, user) {
  try {
    const res = await fetch(`${WORKER_URL}/manage-user`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({roomId: currentRoom, username, targetUser: user, action})
    });
    const data = await res.json();
    if (data.success) {
      loadRoomMembers();
    } else {
      alert(data.error || "Ø®Ø·Ø§");
    }
  } catch {
    alert("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„");
  }
}

async function toggleAdmin(user) {
  try {
    const res = await fetch(`${WORKER_URL}/manage-admin`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({roomId: currentRoom, username, targetUser: user})
    });
    const data = await res.json();
    if (data.success) {
      loadRoomMembers();
    } else {
      alert(data.error || "Ø®Ø·Ø§");
    }
  } catch {
    alert("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„");
  }
}

// Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±ÙˆÙ…
document.getElementById('saveRoomModeBtn').addEventListener('click', async () => {
  const mode = document.querySelector('input[name="roomMode"]:checked').value;
  try {
    const res = await fetch(`${WORKER_URL}/change-room-mode`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({roomId: currentRoom, username, mode})
    });
    const data = await res.json();
    if (data.success) {
      document.getElementById('roomModeStatus').innerHTML = '<p style="color:#50fa7b;">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!</p>';
    } else {
      alert(data.error || "Ø®Ø·Ø§");
    }
  } catch {
    alert("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„");
  }
});

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯
async function loadRequests() {
  if (!currentRoom) return;
  try {
    const res = await fetch(`${WORKER_URL}/room-data?roomId=${currentRoom}&username=${username}`);
    if (!res.ok) return;
    const data = await res.json();
    if (data.isOwner) {
      let html = '';
      data.requests.forEach(user => {
        html += `
          <div class="request-item">
            <span>${user}</span>
            <div class="request-actions">
              <button class="approve" onclick="approveRequest('${user}')">ØªØ£ÛŒÛŒØ¯</button>
              <button class="reject" onclick="rejectRequest('${user}')">Ø±Ø¯</button>
            </div>
          </div>
        `;
      });
      document.getElementById('requestsList').innerHTML = html || '<p style="opacity:0.7;">Ù‡ÛŒÚ† Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ Ù†ÛŒØ³Øª</p>';
    } else {
      document.getElementById('requestsList').innerHTML = '<p style="opacity:0.7;">ÙÙ‚Ø· Ù‡Ø§Ø³Øª Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø¨ÛŒÙ†Ø¯</p>';
    }
  } catch {
    document.getElementById('requestsList').innerHTML = '<p style="color:#ff6b6b;">Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„</p>';
  }
}

// ØªØ£ÛŒÛŒØ¯/Ø±Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
async function approveRequest(user) {
  try {
    const res = await fetch(`${WORKER_URL}/approve-request`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({roomId: currentRoom, username, targetUser: user})
    });
    const data = await res.json();
    if (data.success) loadRequests();
  } catch { alert("Ø®Ø·Ø§"); }
}
async function rejectRequest(user) {
  try {
    const res = await fetch(`${WORKER_URL}/reject-request`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({roomId: currentRoom, username, targetUser: user})
    });
    const data = await res.json();
    if (data.success) loadRequests();
  } catch { alert("Ø®Ø·Ø§"); }
}

// Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÙ…â€ŒÙ‡Ø§
async function loadMyRooms() {
  if (!username) {
    document.getElementById('myRoomsList').innerHTML = '<p style="color:#ff6b6b;">Ø§Ø¨ØªØ¯Ø§ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯</p>';
    return;
  }
  try {
    const res = await fetch(`${WORKER_URL}/my-rooms?username=${username}`);
    if (!res.ok) {
      document.getElementById('myRoomsList').innerHTML = '<p style="color:#ff6b6b;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø±ÙˆÙ…â€ŒÙ‡Ø§</p>';
      return;
    }
    const rooms = await res.json();
    if (rooms.length === 0) {
      document.getElementById('myRoomsList').innerHTML = '<p style="opacity:0.7;">Ù‡Ù†ÙˆØ² Ø±ÙˆÙ…ÛŒ Ù†Ø³Ø§Ø®ØªÙ‡â€ŒØ§ÛŒØ¯</p>';
      return;
    }
    let html = '';
    rooms.forEach(room => {
      html += `
        <div class="room-item">
          <span>${room}</span>
          <div class="room-actions">
            <button onclick="editRoomName('${room}')">ÙˆÛŒØ±Ø§ÛŒØ´</button>
            <button style="background:#ff4444;" onclick="deleteRoom('${room}')">Ø­Ø°Ù</button>
          </div>
        </div>
      `;
    });
    document.getElementById('myRoomsList').innerHTML = html;
  } catch {
    document.getElementById('myRoomsList').innerHTML = '<p style="color:#ff6b6b;">Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„</p>';
  }
}

async function editRoomName(oldId) {
  const newId = prompt("Ø¢ÛŒØ¯ÛŒ Ø¬Ø¯ÛŒØ¯ Ø±ÙˆÙ… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ Ø­Ø¯Ø§Ù‚Ù„ 3 Ú©Ø§Ø±Ø§Ú©ØªØ±):", oldId);
  if (!newId || newId === oldId) return;
  if (newId.length < 3 || !/^[a-z0-9_-]+$/.test(newId)) {
    alert("Ø¢ÛŒØ¯ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª");
    return;
  }
  try {
    const res = await fetch(`${WORKER_URL}/rename-room`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({oldRoomId: oldId, newRoomId: newId, username})
    });
    const data = await res.json();
    if (data.success) {
      alert("Ù†Ø§Ù… Ø±ÙˆÙ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯!");
      loadMyRooms();
      if (currentRoom === oldId) {
        currentRoom = newId;
        document.getElementById('roomTitle').textContent = `Ø±ÙˆÙ…: ${newId}`;
      }
    } else {
      alert(data.error || "Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± Ù†Ø§Ù…");
    }
  } catch {
    alert("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„");
  }
}

async function deleteRoom(roomId) {
  if (!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø±ÙˆÙ… "${roomId}" Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ù…ÛŒØ´Ù‡ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ`)) return;
  try {
    const res = await fetch(`${WORKER_URL}/delete-room`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({roomId, username})
    });
    const data = await res.json();
    if (data.success) {
      alert("Ø±ÙˆÙ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯!");
      loadMyRooms();
      if (currentRoom === roomId) {
        currentRoom = null;
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('home').classList.add('active');
      }
    } else {
      alert(data.error || "Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø±ÙˆÙ…");
    }
  } catch {
    alert("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„");
  }
}

// Ú©Ø¯ Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
const plainText = document.getElementById("plainText");
const password = document.getElementById("password");
const output = document.getElementById("output");
const fileInput = document.getElementById("fileInput");
const copyBtn = document.getElementById("copyBtn");
const pasteBtn = document.getElementById("pasteBtn");
const encryptBtn = document.getElementById("encryptBtn");
const decryptBtn = document.getElementById("decryptBtn");

document.getElementById("togglePlain").addEventListener('click', () => {
  plainText.style.webkitTextSecurity = plainText.style.webkitTextSecurity === "disc" ? "none" : "disc";
});
document.getElementById("togglePass").addEventListener('click', () => {
  password.type = password.type === "text" ? "password" : "text";
});
pasteBtn.addEventListener('click', async () => {
  try {
    const text = await navigator.clipboard.readText();
    plainText.value = text.trim();
    alert("Ù…ØªÙ† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾ÛŒØ³Øª Ø´Ø¯! ğŸ‘");
  } catch (err) {
    alert("Ù¾ÛŒØ³Øª Ø§ØªÙˆÙ…Ø§ØªÛŒÚ© Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ ğŸ˜•\n\nØ±Ø§Ù‡ Ø¢Ø³Ø§Ù†: Ù…ØªÙ† Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯ØŒ Ø³Ù¾Ø³ Ø¯Ø§Ø®Ù„ Ø¨Ø§Ú©Ø³ Long Press Ú©Ù†ÛŒØ¯ Ùˆ 'Paste' Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.");
  }
});
copyBtn.addEventListener('click', () => {
  if (!output.value.trim()) {
    alert("Ø®Ø±ÙˆØ¬ÛŒ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª! Ø§ÙˆÙ„ Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø²Ú¯Ø´Ø§ÛŒÛŒ Ú©Ù†ÛŒØ¯.");
    return;
  }
  output.select();
  document.execCommand("copy");
  alert("Ù…ØªÙ† Ø®Ø±ÙˆØ¬ÛŒ Ú©Ù¾ÛŒ Ø´Ø¯! Ø­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯ ğŸ“‹");
});
async function deriveKey(pass, salt) {
  const base = await crypto.subtle.importKey("raw", new TextEncoder().encode(pass), "PBKDF2", false, ["deriveKey"]);
  return crypto.subtle.deriveKey(
    {name: "PBKDF2", salt, iterations: 200000, hash: "SHA-256"},
    base, {name: "AES-GCM", length: 256}, false, ["encrypt", "decrypt"]
  );
}
async function encrypt(text, pass) {
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await deriveKey(pass, salt);
  const cipher = await crypto.subtle.encrypt({name: "AES-GCM", iv}, key, new TextEncoder().encode(text));
  return btoa(String.fromCharCode(...salt, ...iv, ...new Uint8Array(cipher)));
}
async function decrypt(data, pass) {
  const raw = Uint8Array.from(atob(data), c => c.charCodeAt(0));
  const salt = raw.slice(0,16);
  const iv = raw.slice(16,28);
  const ct = raw.slice(28);
  const key = await deriveKey(pass, salt);
  const plain = await crypto.subtle.decrypt({name: "AES-GCM", iv}, key, ct);
  return new TextDecoder().decode(plain);
}
encryptBtn.addEventListener('click', async () => {
  if (!password.value) return alert("Ø±Ù…Ø² ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡");
  if (!plainText.value.trim()) return alert("Ù…ØªÙ† Ø®Ø§Ù„ÛŒ Ø§Ø³Øª");
  try {
    const result = await encrypt(plainText.value.trim(), password.value);
    output.value = result;
    const isCopyMode = document.querySelector('input[name="appMode"]:checked').value === "copy";
    if (isCopyMode) {
      alert("Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ Ù…ÙˆÙÙ‚! Ø­Ø§Ù„Ø§ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Copy Ø¨Ø²Ù†ÛŒØ¯.");
    } else {
      const blob = new Blob([result], {type: "text/plain"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "secure.enc";
      a.style.display = "none";
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        URL.revokeObjectURL(url);
        document.body.removeChild(a);
      }, 1000);
      alert("ÙØ§ÛŒÙ„ Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒâ€ŒØ´Ø¯Ù‡ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯ (secure.enc)");
    }
    plainText.value = "";
    password.value = "";
  } catch (e) {
    alert("Ø®Ø·Ø§ Ø¯Ø± Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ");
  }
});
decryptBtn.addEventListener('click', () => {
  if (!password.value) return alert("Ø±Ù…Ø² ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡");
  const isCopyMode = document.querySelector('input[name="appMode"]:checked').value === "copy";
  if (isCopyMode) {
    if (!plainText.value.trim()) return alert("ÙˆØ±ÙˆØ¯ÛŒ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª! Ù…ØªÙ† Ø±Ù…Ø² Ø´Ø¯Ù‡ Ø±Ø§ Ù¾ÛŒØ³Øª Ú©Ù†ÛŒØ¯");
    decryptFromText();
  } else {
    fileInput.click();
  }
});
async function decryptFromText() {
  try {
    output.value = await decrypt(plainText.value.trim(), password.value);
    plainText.value = "";
  } catch (e) {
    alert("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª ÛŒØ§ Ù…ØªÙ† Ø®Ø±Ø§Ø¨ Ø§Ø³Øª");
  }
}
fileInput.addEventListener('change', async () => {
  if (!fileInput.files[0]) return;
  try {
    const text = await fileInput.files[0].text();
    output.value = await decrypt(text, password.value);
  } catch (e) {
    alert("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª ÛŒØ§ ÙØ§ÛŒÙ„ Ø®Ø±Ø§Ø¨ Ø§Ø³Øª");
  }
  fileInput.value = "";
});
</script>
</body>
</html>
